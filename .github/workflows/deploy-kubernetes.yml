name: Deploy to Kubernetes

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Build services
        run: |
          for service in services/*/; do
            service_name=$(basename "$service")
            docker build -t pivori/$service_name:latest "$service"
          done
      
      - name: Build frontend
        run: docker build -t pivori/frontend:latest frontend/
      
      - name: Deploy to Kubernetes
        run: |
          kubectl set image deployment/geolocation geolocation=pivori/geolocation:latest -n pivori-production
          kubectl set image deployment/routing routing=pivori/routing:latest -n pivori-production
          kubectl rollout status deployment/geolocation -n pivori-production
          kubectl rollout status deployment/routing -n pivori-production
      
      - name: Run smoke tests
        run: |
          kubectl run smoke-test --image=curlimages/curl --rm -it -- curl http://geolocation:8000/health
